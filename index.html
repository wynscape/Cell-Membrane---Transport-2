<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fluid Mosaic Model: Transport | Biology@RI</title>
    <style>
        /* WYNSCAPE DESIGN SYSTEM */
        :root {
            --bg: #FFFFFF;
            --text-main: #1f2937;
            --lipid-head: #60a5fa; /* Light Blue */
            --lipid-tail: #475569; /* Dark Grey (Increased Intensity) */
            --cytoplasm: #fdfbf7;  /* Warm Beige */
            --vesicle-bg: #e5e7eb;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        /* HEADER */
        header {
            padding: 1rem 1.5rem;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.02em;
        }

        /* CONTROLS */
        .controls {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            z-index: 20;
        }

        select {
            appearance: none;
            background-color: #fff;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 8px 32px 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='2'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3e%3c/path%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
        }

        /* CANVAS */
        #container {
            flex-grow: 1;
            position: relative;
            width: 100%;
            height: 100%;
            cursor: grab;
            overflow: hidden;
        }
        
        #container:active { cursor: grabbing; }

        canvas { display: block; width: 100%; height: 100%; }

        /* FOOTER */
        footer {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.7rem;
            color: #94a3b8;
            pointer-events: none;
            z-index: 20;
        }

        .toast {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #64748b;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            z-index: 20;
            transition: opacity 0.5s;
        }
        
        @media print { body { display: none; } }
    </style>
</head>
<body>

<header>Biology@RI</header>

<div class="controls">
    <select id="_mSel">
        <option value="0">Endocytosis (General)</option>
        <option value="1">Phagocytosis</option>
        <option value="2">Pinocytosis</option>
    </select>
</div>

<div id="container">
    <canvas id="_c"></canvas>
    <div class="toast" id="_tst">Drag the molecule to the membrane</div>
</div>

<footer>&copy; Wynscape Education | All rights reserved</footer>

<script>
/**
 * CELL MEMBRANE SIMULATION
 * Features: Fluid Mosaic physics, Bilayer wrapping, Constant thickness geometry.
 * Security: Obfuscated logic layer.
 */
(function(){
    // 1. SECURITY
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false; 
        if(e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) return false;
        if(e.ctrlKey && e.keyCode == 85) return false;
    };

    const _cvs = document.getElementById('_c');
    const _ctx = _cvs.getContext('2d');
    const _sel = document.getElementById('_mSel');
    const _tst = document.getElementById('_tst');

    // CONFIGURATION
    let _w, _h, _t = 0;
    let _lipids = [];
    const _L_HEAD_R = 6;      // Lipid Head Radius
    const _L_TAIL_H = 30;     // Tail Length
    const _BILAYER_GAP = 50;  // Gap between tail ends (Upper layer tail end to Lower layer tail end)
    const _MEM_THICKNESS = (_L_TAIL_H * 2) + _BILAYER_GAP; // Total thickness head-center to head-center
    
    // MOLECULE STATE
    const _mol = { 
        x: 0, y: 0, 
        r: 18, 
        drag: false, 
        isVesicle: false, 
        startY: 0 
    };
    
    // COLORS
    const C_HEAD = '#60a5fa';
    const C_TAIL = '#475569'; // Darkened grey
    const C_MOL = '#9ca3af';  // Grey molecule
    const C_CYTO = '#f5f5dc'; // Beige Cytoplasm

    function _init() {
        _w = _cvs.width = window.innerWidth;
        _h = _cvs.height = window.innerHeight;
        
        // Initial Position: Closer to membrane (Reduce distance by 50%)
        // Membrane is at _h/2. Previous start was 0.15*_h. 
        // We want it closer.
        _mol.startY = (_h / 2) - 120; 
        _reset();
        
        // Generate Lipid X positions
        _lipids = [];
        const count = Math.ceil(_w / 14) + 5; 
        for(let i = -5; i < count; i++) {
            _lipids.push(i * 14);
        }
    }

    function _reset() {
        _mol.x = _w / 2;
        _mol.y = _mol.startY;
        _mol.drag = false;
        _mol.isVesicle = false;
        _tst.style.opacity = 1;
    }

    // MATH HELPERS
    // Calculate the membrane curve Y at position x
    function _getMembraneY(x, time) {
        // Base Wave
        let y = (_h / 2) + Math.sin(x * 0.02 + time) * 5;
        
        // If vesicle is fully formed, membrane heals (returns to flat sine wave)
        if (_mol.isVesicle) return y;

        // Interaction (Invagination)
        const dx = x - _mol.x;
        // The "Pit" logic
        // We want a U shape that turns into an O shape
        // Threshold: How close is molecule to membrane?
        const distToMem = Math.max(0, _mol.y - y); 
        
        // If molecule is pushing down
        if (_mol.y > y - _mol.r - 20) {
            // Gaussian indentation
            // Width of the pit depends on molecule size + padding
            const width = 60; 
            const depth = Math.max(0, _mol.y - (_h/2 - _mol.r - _MEM_THICKNESS/2)); 
            
            // Create a smooth well
            // Only affect area within width
            if (Math.abs(dx) < width * 2) {
                // Smooth Step function for pit shape
                const influence = Math.exp(-(dx*dx) / (2 * (width/2)*(width/2)));
                y += influence * depth;
            }
        }
        return y;
    }

    // Get Normal Vector (perpendicular to curve) for constant thickness
    function _getNormal(x, time) {
        const d = 0.1;
        const y1 = _getMembraneY(x - d, time);
        const y2 = _getMembraneY(x + d, time);
        const tanAngle = Math.atan2(y2 - y1, d * 2);
        // Normal is tangent + 90 deg
        return {
            x: -Math.sin(tanAngle),
            y: Math.cos(tanAngle),
            ang: tanAngle
        };
    }

    // INPUT HANDLERS
    function _getPos(e) {
        const r = _cvs.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    }

    function _down(e) {
        const p = _getPos(e);
        if (Math.hypot(p.x - _mol.x, p.y - _mol.y) < 40) {
            _mol.drag = true;
            _tst.style.opacity = 0;
        }
    }

    function _move(e) {
        if (!_mol.drag) return;
        e.preventDefault();
        const p = _getPos(e);
        _mol.x = p.x;
        
        // Limit movement
        const maxY = _h - 40; // 1 line above footer
        _mol.y = Math.min(maxY, p.y);
        
        // Logic check: Did we pinch off?
        // If molecule goes deep enough, become vesicle
        if (!_mol.isVesicle && _mol.y > (_h/2) + 80) {
            _mol.isVesicle = true;
        }
    }

    function _up() {
        _mol.drag = false;
        // Snap back if released in Extracellular space or barely touching
        if (!_mol.isVesicle && _mol.y < _h/2) {
            _snapBack();
        }
    }

    function _snapBack() {
        if (_mol.drag || _mol.isVesicle) return;
        _mol.x += (_w/2 - _mol.x) * 0.1;
        _mol.y += (_mol.startY - _mol.y) * 0.1;
        if (Math.abs(_mol.y - _mol.startY) > 0.5) requestAnimationFrame(_snapBack);
    }

    _cvs.addEventListener('mousedown', _down);
    window.addEventListener('mousemove', _move);
    window.addEventListener('mouseup', _up);
    _cvs.addEventListener('touchstart', _down, {passive:false});
    window.addEventListener('touchmove', _move, {passive:false});
    window.addEventListener('touchend', _up);
    _sel.addEventListener('change', _reset);
    window.addEventListener('resize', _init);

    // DRAWING
    function _drawLipid(ctx, x, y, nx, ny, angle, isUpper) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        
        const dir = isUpper ? 1 : -1;
        
        // Draw Tails (Darker Grey)
        ctx.strokeStyle = C_TAIL;
        ctx.lineWidth = 2;
        ctx.beginPath();
        // Two tails
        ctx.moveTo(-2, 0); ctx.lineTo(-2, dir * _L_TAIL_H);
        ctx.moveTo(2, 0); ctx.lineTo(2, dir * _L_TAIL_H);
        ctx.stroke();

        // Draw Head (Light Blue)
        ctx.fillStyle = C_HEAD;
        ctx.beginPath();
        ctx.arc(0, 0, _L_HEAD_R, 0, Math.PI*2);
        ctx.fill();

        ctx.restore();
    }

    function _loop() {
        _t += 0.05;
        _ctx.clearRect(0,0,_w,_h);

        // 1. DRAW CYTOPLASM BACKGROUND (Beige)
        // Must follow the contour of the LOWER membrane layer
        _ctx.fillStyle = C_CYTO;
        _ctx.beginPath();
        _ctx.moveTo(0, _h); // Bottom Left
        
        // Trace the bottom layer of the membrane
        // We iterate X to build the wave path
        for(let x = 0; x <= _w; x+=10) {
            const my = _getMembraneY(x, _t);
            const norm = _getNormal(x, _t);
            // Bottom heads are at center + (thickness/2 * normal)
            const by = my + (_MEM_THICKNESS/2 * norm.y);
            _ctx.lineTo(x, by);
        }
        
        _ctx.lineTo(_w, _h); // Bottom Right
        _ctx.closePath();
        _ctx.fill();

        // 2. LABEL CYTOPLASM
        _ctx.fillStyle = "#9ca3af";
        _ctx.font = "bold 24px sans-serif";
        _ctx.textAlign = "left";
        _ctx.fillText("CYTOPLASM", 20, _h - 80);

        // 3. DRAW MAIN MEMBRANE
        // Iterating lipids
        for (let x of _lipids) {
            const centerY = _getMembraneY(x, _t);
            const norm = _getNormal(x, _t);
            
            // Calculate Head positions using Normal Vector to maintain CONSTANT GAP
            // Top Head
            const tx = x + (norm.x * -_MEM_THICKNESS/2);
            const ty = centerY + (norm.y * -_MEM_THICKNESS/2);
            
            // Bottom Head
            const bx = x + (norm.x * _MEM_THICKNESS/2);
            const by = centerY + (norm.y * _MEM_THICKNESS/2);

            // Draw Top Layer (tails pointing down relative to head)
            _drawLipid(_ctx, tx, ty, norm.x, norm.y, norm.ang, true);
            
            // Draw Bottom Layer (tails pointing up relative to head)
            _drawLipid(_ctx, bx, by, norm.x, norm.y, norm.ang, false);
        }

        // 4. DRAW MOLECULE / VESICLE
        if (_mol.isVesicle) {
            // VESICLE MODE (Bilayer around molecule)
            
            // Draw Molecule (Grey)
            _ctx.fillStyle = C_MOL;
            _ctx.beginPath();
            _ctx.arc(_mol.x, _mol.y, _mol.r, 0, Math.PI*2);
            _ctx.fill();

            // Draw Vesicle Bilayer
            // We need an Inner Ring and an Outer Ring
            const innerR = _mol.r + 5 + _L_HEAD_R; // Close to molecule
            const outerR = innerR + _MEM_THICKNESS; // Constant thickness away
            
            const numLips = 16;
            for(let i=0; i<numLips; i++) {
                const ang = (i / numLips) * Math.PI * 2 + _t * 0.5;
                
                // Inner Layer (Heads inside, tails out? No, Bilayer structure)
                // A vesicle bilayer: Cytosolic fluid -> Head-Tail-Tail-Head -> Inner content
                // Inner layer: Heads touching molecule (approx), tails pointing OUT
                // Outer layer: Heads touching cytoplasm, tails pointing IN
                
                // Correction: Vesicle contains extracellular fluid. 
                // So Inner Heads touch the fluid (molecule). 
                // Outer Heads touch the cytoplasm.
                
                // Inner Lipid Position
                const ix = _mol.x + Math.cos(ang) * innerR;
                const iy = _mol.y + Math.sin(ang) * innerR;
                
                // Outer Lipid Position
                const ox = _mol.x + Math.cos(ang) * outerR;
                const oy = _mol.y + Math.sin(ang) * outerR;

                // Draw Inner (Tails pointing OUTWARD from center)
                _ctx.save();
                _ctx.translate(ix, iy);
                _ctx.rotate(ang + Math.PI/2); // Rotate to face center
                
                // Head
                _ctx.fillStyle = C_HEAD;
                _ctx.beginPath(); _ctx.arc(0,0, _L_HEAD_R, 0, Math.PI*2); _ctx.fill();
                // Tail (pointing up relative to this rotation = away from center)
                _ctx.strokeStyle = C_TAIL; _ctx.lineWidth=2;
                _ctx.beginPath(); 
                _ctx.moveTo(-2,0); _ctx.lineTo(-2, -_L_TAIL_H);
                _ctx.moveTo(2,0); _ctx.lineTo(2, -_L_TAIL_H);
                _ctx.stroke();
                _ctx.restore();

                // Draw Outer (Tails pointing INWARD to center)
                _ctx.save();
                _ctx.translate(ox, oy);
                _ctx.rotate(ang + Math.PI/2);
                 // Head
                _ctx.fillStyle = C_HEAD;
                _ctx.beginPath(); _ctx.arc(0,0, _L_HEAD_R, 0, Math.PI*2); _ctx.fill();
                // Tail (pointing down = toward center)
                _ctx.strokeStyle = C_TAIL; _ctx.lineWidth=2;
                _ctx.beginPath(); 
                _ctx.moveTo(-2,0); _ctx.lineTo(-2, _L_TAIL_H);
                _ctx.moveTo(2,0); _ctx.lineTo(2, _L_TAIL_H);
                _ctx.stroke();
                _ctx.restore();
            }

        } else {
            // NORMAL MOLECULE
            _ctx.fillStyle = C_MOL;
            _ctx.beginPath();
            _ctx.arc(_mol.x, _mol.y, _mol.r, 0, Math.PI*2);
            _ctx.fill();
        }

        requestAnimationFrame(_loop);
    }

    _init();
    _loop();

})();
</script>
</body>
</html>
